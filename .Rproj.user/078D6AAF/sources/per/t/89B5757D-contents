---
title: "Untitled"
output: html_document
date: '2023-05-04'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(janitor)
library(scales)
library(magrittr)
library(flextable)
library(naniar)

theme_set(theme_light())

# disabling scientific notation
options(scipen = 100)


`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}


# scaling functions 
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

#mode function 
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# For filtering columns 
not_all_na <- function(x) any(!is.na(x))
not_any_na <- function(x) all(!is.na(x))

locations <- read_csv("./data/locations_aoc.csv")


# pcode3_shape <- 
#   st_read("./data/syr_admbnda_uncs_unocha_20201217/syr_admbnda_adm3_uncs_unocha_20201217.shp")
 
```

# Some notes to start 

The .xls of the KOBO version of the harmonised tool needs to be downloaded and processed. This is in order to set the "empty container" with which we will match the rest of the datasets that we are cleaning. And go through each of the columns to decide on where and how exactly each partner had been compliant with the tool. Admittedly, I should have started here, but I still don't have access to the back-end of the KOBO survey. Ideally, I would just rename each of the columns in line with the question code in the harmonised tool, so I realised that I wasted a lot of time doing renaming below, though it does make navigating the dataset a little bit easier. 

For reference [link](https://docs.google.com/spreadsheets/d/1JHD1RaSEVRcrJHQ5y_KSzIq8T7OyglkH/edit#gid=243288867) to questionnaire. 

The "empty container" should look something like this:


```{r}
codebook <- tribble(
  ~question, ~question_code, ~class
  "organisation_name", "a1", "character", 
  "governorate", "a2", "character",
  "district", "a3", "character",
  "sub_district", "a4", "character",
  "community", "a5", "character", 
  "enumerator_id", "a6", "character",
  "date", "a7", "date", 
  "respondent_sex", "a8", "character", 
  "head_of_household", "a9", "character", 
  "idp_household", "b1", "character", 
  "returnee_household", "b2", "character", 
  "host_community_household", "b3", "logical", 
  "female_headed_household", "b4", "logical", 
  "elderly_headed_household", "b5", "logical", 
  "injured_disabled_ill_household_member", "b6", "logical", 
  "vulnerable_household_member", "b7", "logical", 
  # This actually should an integer
  "children_under_five", "b8", "logical", 
  # This also should be an integer `hh_size`, since there 
  # already is a question asking hh_size for large households
  "large_household", "b9", "logical", 
  # This is all actually just one question, but I feel that we
  # shouldn't abandoned detailed data collected, even if we do
  # end up aggregating it later. 
  # However, consider a single column `shelter_type`
  "in_collective_shelter", "b10", "logical", 
  "in_damaged_building", "b11", "logical", 
  "in_makeshift_shelter", "b12", "logical", 
  "no_income_generating_assets", "b13", "logical", 
  "hh_size", "b14", "integer", 
  "was_assistance_appropriate", "1.1", "character", 
  "why_not_appropriate", "1.2", "character", 
  "preferred_modality", "1.3", "character", 
  "modality_cash", "1.3.1", "logical", 
  "modality_paper_voucher", "1.3.2", "logical",
  "modality_in_kind", "1.3.3", "logical",
  "modality_etransfer", "1.3.4", "logical",
  "modality_other", "1.3.5", "logical",
  "modality_specify_other", "1.3.99", 
  "preferred_currency", "1.4", "character", 
  "currency_usd", "1.4.1", "logical", 
  "currency_try", "1.4.2", "logical", 
  "currency_syp", "1.4.3", "logical", 
  "currency_any", "1.4.4", "logical", 
  # Makes less sense now to combine it into one column, 
  "items_bought", "2.1", "character", 
  "items_bought_fresh_food", "2.1.1", "logical", 
  "items_bought_dry_food", "2.1.2", "logical",
  "items_bought_cooking_fuel", "2.1.3", "logical",
  "items_bought_heating_fuel", "2.1.4", "logical",
  "items_bought_hh_hygiene_items", "2.1.5", "logical",
  "items_bought_kitchen_utensils", "2.1.6", "logical",
  "items_bought_hh_appliances", "2.1.7", "logical",
  "items_bought_clothes_blankets_bedding", "2.1.8", "logical",
  "items_bought_communication", "2.1.9", "logical",
  "items_bought_debt_repayment", "2.1.11", "logical",
  "items_bought_shelter_NFIs_improvement", "2.1.12", "logical",
  "items_bought_rent", "2.1.13", "logical",
  "items_bought_transportation", "2.1.14", "logical",
  "items_bought_medical", "2.1.15", "logical",
  "items_bought_water", "2.1.16", "logical",
  "items_bought_baby_needs", "2.1.17", "logical",
  "items_bought_electricity_lighting", "2.1.18", "logical",
  "items_bought_education", "2.1.19", "logical",
  "items_bought_savings", "2.1.20", "logical",
  "items_bought_shared_assistance", "2.1.21", "logical",
  "items_bought_other", "2.1.22", "logical",
  "items_bought_specify_other", "2.1.99", "logical",
)

# And so on...
# My thinking here is that first, to complete the codebook, 
# Then rename the matching columns in each dataset accordingly
# Then extract all the matching columns from each of the datasets
# Maybe the easiest way is select(contains()) or select(matches())
# I forget which, 
# But then we would also need to mutate columns full of NAs for 
# to make the rbind() actually work
```


Compliance with the harmonised tool is quite mixed, as even if there is full compliance with the questions, there is not always alignment in the options available. Additional cleaning is necessary in order to process and align it with the harmonised tool.

Longer-term, there is room for improvement in the harmonised tool: several alternative questions that partners have proposed performed better than the options we currently have. For instance, if household size is collected as a number, it should remain a number, as opposed to the "Yes/No" for the question option "We have a large household". Additionally, the AAP section in the harmonised tool seems primarily concerned with PSEA -- GOAL takes a much broader approach to monitoring AAP. 

# Shafak CARE

```{r}
shafak_care <- read_excel("./data/pdm_raw/BHA_COMRES II_CARE_422_Cash_One_off_MPCA PDM For Faris-Shafak.xlsx") %>% 
  # Refer to function in set-up chunk. 
  # Drops all columns that are entirely NA
  select(where(not_all_na)) %>%
  clean_names() %>% 
  rename(governorate = distribution_location_governorate, 
         district = distribution_location_district, 
         sub_district = distribution_location_sub_district, 
         community = distribution_location_town, 
         delivery_modality = distribution_modality,
         site = location_name, 
         # Check if there is something like this in other forms
         voucher_type = distrebuted_voucher_type, 
         hh_size = total_number_of_hh_members, 
         # levels should "No" and "Yes"
         pwds_in_hh = are_there_any_people_with_disabilities_in_your_household, 
         # store them like this, add a fourth and fifth column if it helps with the rbind()
         # But in the analysis, you'll need to pivot_longer()
         # As a further note, the options do not match with the harmonised tool, 
         # so after pivoting, you will still need to clean this column 
         items_bought1 = 
           on_what_did_your_household_spend_use_the_cash_received_from_the_vouchers,
         items_bought2 = 
           on_what_did_your_household_spend_use_the_cash_received_from_the_vouchers_100,
         items_bought3 = 
           on_what_did_your_household_spend_use_the_cash_received_from_the_vouchers_101,
         unmet_needs = 
           what_are_your_households_three_most_urgent_and_important_needs_that_are_not_currently_met, 
         was_assistance_appropriate = 
           do_you_think_the_assistance_you_received_were_in_line_with_your_needs, 
         favours_exchange_assistance = 
           were_you_asked_to_give_anything_money_goods_services_in_return_to_get_this_support_72, 
         # Not exactly compliant with the harmonised tool; this is free text 
         how_has_cash_transfer_impacted_your_life = 
           please_give_an_example_of_how_the_cash_transfers_vouchers_etc_impacted_your_life_or_the_lives_of_others_in_your_household_positively_or_negatively) %>% 
  # Inelegant, because you'll still need to trimws after you separate, 
  # but it makes more sense to store it all in one column 
  mutate(unmet_needs = str_replace_all(unmet_needs, "Shelter/Housing", "Shelter"), 
         unmet_needs = str_replace_all(
           unmet_needs,
           pattern = "([[:upper:]])",
           replacement = ", \\1"), 
         unmet_needs = str_sub(unmet_needs, start = 3L, end = -1L)) %>% 
  # Not sure about this transformation.
  # Maybe it's better to say that they didn't comply with 3.4 and 3.5
  mutate(challenges_spending_exchanging = 
           ifelse(were_you_satisfied_with_the_redemption_process  %in% 
                    c("Strongly Satisfied","Satisfied"),
                  "Yes", "No"))

```

Shafak-CARE's demographic questions don't exactly match the harmonised too; they are all "Yes/No", probably fine to store them like that, in preparation for the rbind(): 

female_headed_household 
child_headed_household  
families_without_a_head_of_household 
injured_disabled_headed_households 
households_with_at_least_one_elderly_chronically_ill_or_disabled_person 
households_living_in_collective_shelter_abandoned_building_or_equivalent_poor_living_conditions
households_that_have_not_receved_assistance_in_the_past_two_months_from_relatives_or_other_actors 
households_with_multiple_children_under_5_years_total_family_more_than_7

In GOAL and Shafak-CARE, the community tensions question is separate from the question on disagreements. Both these questions are combined in Q5.10 in the harmonised tool. 

Shafak-CARE also doesn't ask about what the transfer value of the cash disbursed was. 



# GOAL

```{r}

# GOAL's NA is "---"
goal <- 
  read_excel("./data/pdm_raw/EQ Emergency PDM Data GOAL.xlsx") %>% 
  select(-form.date) %>% 
  replace_with_na_all(condition = ~ .x == "---") %>% 
  select(where(not_all_na)) %>% 
  clean_names() %>% 
  rename_all(funs(
    str_replace_all(., "form_", "") %>% 
      str_replace_all(., "_choice", "")
  )) %>% 
  # Doing this because the date column is blocking me from replacing 
  # all "---" with NAs, because dealing with dates is irritating
  left_join(read_excel("./data/pdm_raw/EQ Emergency PDM Data GOAL.xlsx") %>% 
              select(formid, date = form.date), 
            by = "formid") %>% 
  rename(share_assistance = 
           has_anyone_asked_you_to_share_part_of_the_assistance_you_received_to_be_given_to_other_families, 
         fee_tax_assistance = 
           has_anyone_taxed_you_money_or_vouchers_or_items_or_services_or_favours_in_order_to_receive_the_assistance_or_after_receiving_it, 
         tensions_family_community = any_tension_between_you_and_your_community, 
         disagreements_within_family = any_disagreements_within_your_family, 
         transfer_value_usd = cash_what_is_the_value_of_cash_you_have_received_usd, 
         satisfied_with_banknote_quality =
           cash_were_you_satisfied_with_the_quality_of_usd_banknote, 
         governorate = location_details_governorate, 
         district = location_details_district, 
         sub_district = location_details_subdistrict, 
         community = location_details_village, 
         latitude_y = location_details_latitude, 
         longitude_x = location_details_longitude) %>% 
  # Just capitalising the first letter of Yesses and Nos
  mutate_at(vars(share_assistance, 
                 fee_tax_assistance, 
                 tensions_family_community, 
                 satisfied_with_banknote_quality), ~ str_to_title(.)) %>% 
  # Easiest way to rename long columns, though
  # this is not exactly relevant, since we should start with the codebook
  select_all(~ gsub("cash_were_you_satisfied_with_the_quality_of_usd_banknote_if_no_why_", "", .)) %>% 
  # This only shortens the names, when the dataset is combined, 
  select_all(~ gsub("any_tension_between_you_and_your_community_if_yes_how", "tension", .)) %>% 
  select_all(~ gsub("cash_what_items_did_you_purchase_with_the_cash", "items_bought", .)) %>% 

```

Other relevant GOAL questions 

cash_did_you_face_any_problems_with_the_money_trader
cash_please_explain_the_problems_you_faced_with_the_money_trader
cash_who_in_the_hh_was_responsible_for_spending_the_cash


```{r}

goal %>% glimpse()
```

GOAL outperforms on Q2.2, they ask for the actual breakdowns on item categories i.e. how much did your household spend on xx? As opposed to "Which are the top three items that your household spent the most money on?". 


# Syria Relief 


```{r}
syria_relief <- read_excel("./data/pdm_raw/First Q_PDM_SR_MPCA Syria Relief.xlsx") %>% 
  clean_names() %>% 
  select(where(not_all_na)) %>% 
  rename_at(vars(x1_3_governorate:x1_6_village,), ~ str_sub(., start = 6L, end = -1L)) %>% 
  rename(respondent_age = x2_1_age_of_the_respondent, 
         respondent_sex = x2_2_what_is_the_sex_of_the_respondent) %>% 
  mutate(idp_household = ifelse(x2_5_1_current_residence_status == "Internally or Internationally Displaced", "Yes", "No")) 

```

```{r}
syria_relief

syria_relief %>% count(x2_5_1_current_residence_status)
```


